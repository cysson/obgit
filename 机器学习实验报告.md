实验结果：经过训练，在val数据集上的AUROC为0.907.
在相同验证集上，视觉-语言模型（VLM）取得了 0.707 的图像级 AUROC，与 PatchCore 持平。值得注意的是，两种方法路径迥异：PatchCore 仅依赖 CNN 局部特征记忆，而 VLM 通过图文对齐机制将异常语义隐式编码到联合嵌入空间。结果持平一方面说明「异常」概念在语言模态中可被有效检索，另一方面也提示 VLM 尚未充分发挥其语义泛化优势——依旧停留在「判别」而非「理解」层面。未来若引入缺陷文本提示微调或图文对比蒸馏，有望利用语言先验突破纯视觉方法的天花板，实现小样本甚至零样本的跨品类异常检测。
```python
def ensure_constraints_and_indexes():

    with driver.session() as s:
        # 唯一约束示例（Neo4j 5 语法）
        s.run("""
        CREATE CONSTRAINT IF NOT EXISTS unique_entity_id
        FOR (n:Resource)
        REQUIRE n.id IS UNIQUE
        """)
        
        s.run("""
        CREATE FULLTEXT INDEX IF NOT EXISTS entitySearchIndex
        FOR (n:Person|Organisation|Place|Resource)
        ON EACH [n.name, n.name_zh, n.abstract]
        """)
```
## 4. 核心功能模块

### 4.1 节点管理模块


|接口|方法|功能描述|
|:--|:--|:--|
|`/api/query/node`|GET|根据标签和属性查询节点|
|`/api/add/node`|POST|创建新节点|
|`/api/delete/node`|DELETE|删除节点及其所有关系|
|`/api/update/node`|PATCH|更新节点属性|

### 4.2 关系管理模块

表格

复制

|接口|方法|功能描述|
|:--|:--|:--|
|`/api/add/edge`|POST|创建两个节点之间的关系|
|`/api/delete/edge`|DELETE|删除指定关系|
|`/api/update/edge`|PATCH|更新关系属性|

### 4.3 高级查询模块

表格

复制

|接口|方法|功能描述|
|:--|:--|:--|
|`/api/search`|GET|全文搜索实体|
|`/api/entity/{id}/neighbors`|GET|获取实体的一度邻居|
|`/api/path`|GET|计算两个实体间的最短路径|
|`/api/timeline/{id}`|GET|获取实体的时间线事件|

## 5. 数据模型设计

### 5.1 节点模型 (Node)


```python
class Node(BaseModel):
    label: str          # 节点标签
    properties: dict    # 节点属性字典
```

### 5.2 关系模型 (Edge)

Python

复制

```python
class Edge(BaseModel):
    start_label: str    # 起始节点标签
    start_node_id: str  # 起始节点ID
    end_label: str      # 结束节点标签
    end_node_id: str    # 结束节点ID
    relation: str       # 关系类型
    properties: dict    # 关系属性
```

## 6. 数据库设计

- **节点标签**: 支持动态标签，如 Person、Organization、Event 等
    
- **关系类型**: 支持动态关系类型，如 WORKS_FOR、LOCATED_IN 等
    
- **索引**: 使用全文索引 `entitySearchIndex` 优化搜索性能
    

## 7. API 详细设计

### 7.1 节点查询接口

**GET /api/query/node**

- 参数: label, key, value, limit, skip
    
- 功能: 根据指定标签和属性值查询节点
    
- 返回: 节点列表
    

### 7.2 实体搜索接口

**GET /api/search**

- 参数: q(搜索关键词), limit
    
- 功能: 使用全文索引搜索实体
    
- 返回: 匹配实体列表(包含ID、名称、类型、摘要)
    

### 7.3 邻居查询接口

**GET /api/entity/{entity_id}/neighbors**

- 参数: entity_id, relationType(可选), nodeLabel(可选)
    
- 功能: 获取指定实体的一度邻居
    
- 支持动态过滤: 可按关系类型和目标节点标签过滤
    
- 返回: 中心节点及其出站关系
    

### 7.4 最短路径接口

**GET /api/path**

- 参数: start, end, max_hops
    
- 功能: 计算两个实体间的最短路径
    
- 限制: 最大搜索深度为5跳
    
- 返回: 路径列表
    

### 7.5 时间线接口

**GET /api/timeline/{entity_id}`

- 参数: entity_id
    
- 功能: 获取实体按时间排序的相关事件
    
- 时间来源: 关系或目标事件的date属性
    
- 返回: 时间线事件列表




```python
1. 会话上下文管理器：自动关闭 driver 会话，异常时回滚
2. f-string 拼接标签与属性键，label/key 不走索引也会语法正确
3. session.run() 返回 Cursor，懒加载迭代
4. 列表推导式把 Node 对象转成 dict，丢掉 Neo4j 元数据
5. FastAPI 自动序列化为 JSON
```

## 8. 性能优化

1. **索引优化**: 使用 `create_indexes()` 创建必要的索引
    
2. **查询优化**: 使用参数化查询防止注入攻击
    
3. **分页支持**: 节点查询支持 limit 和 skip 参数
    
4. **全文搜索**: 使用 Neo4j 全文索引加速搜索